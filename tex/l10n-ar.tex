\startenvironment l10n-ar

%
% variables
%
\setvariables
  [l10n-manual]
  [title=,
   subtitle=,
   author=,
   translator1=,
   translator2=,
   keywords=,
   direction=,
   language=]

\unexpanded\def\setuplocalisationmanual[#1]
  {\setvariables[l10n-manual][#1]}

%
% directionality
%
\usemodule[bidi]
\setupbidi[bidi=on]

\appendtoks
  \setupbidi[main=\getvariable{l10n-manual}{direction}]
\to \everystarttext

\def\ltr#1{{\bidilre#1\bidipop}}

%
% language
%
\appendtoks
  \mainlanguage[\getvariable{l10n-manual}{language}]
\to \everypar

%
% fonts
%
\setupbodyfont[adobearabic]

%\doifmodeelse{screen}
%  {\setupbodyfont[14pt]}
%  {
   \setupbodyfont[12pt]
%  }

%
% cover page
%

\startsetups page:cover
  \startstandardmakeup[doublesided=no]
    \startalignment[right]
      \framed[align=right,width=.5\textwidth,frame=off]
        {\definedfont[Serif sa 5]\getvariable{l10n-manual}{title}}
      \blank[4*big]
      \bfc
      \getvariable{l10n-manual}{subtitle}
      \startmode[screen]
      \blank[4*big]
      \getvariable{l10n-manual}{author}
      \blank
      \framed[frame=off,align=r2l]{\tfx ترجمة:}\par %XXX: make localisable
      \getvariable{l10n-manual}{translator1}\par
      \getvariable{l10n-manual}{translator2}
      \stopmode
    \stopalignment
  \stopstandardmakeup
\stopsetups

\def\CoverPage{\setups{page:cover}}

%
% chapter header
%
\definepagebreak
  [ChapterBreak]
  [yes,header,right]

\setuphead
  [chapter]
  [style=\bfd,
   page=ChapterBreak,
   before={\blank[force,4*line]},
   after={\blank[4*line]},
   alternative=margin,
   number=yes,
   numbercommand=\MyChapterNumber,
   header=empty,
   footer=chapterstart]

%\startmode[screen]
%  \setuphead
%    [chapter]
%    [before={\blank[force,line]}]
%\stopmode

\def\MyChapterNumber#1{%
  \inframed
    [frame=off,rightframe=on,
     offset=.5em,
     rulethickness=.1ex,
     align=left]{#1}}

\definetext
  [chapterstart]
  [footer]
  [pagenumber]

%
% heads
%
\setuphead
  [section]
  [style=\bic]

\setuphead
  [subsection]
  [style=\bfb]

\setuphead
  [subsubsection]
  [style=\bfa]

\setuphead
  [section,subsection,subsubsection]
  [command=\dummy]

\def\dummy#1#2{#2} % fixme

%
% page numbering
%
\setuppagenumbering
  [alternative=doublesided,
   location=]

\setupheadertexts
  []
  [\setups{text:header:odd}]
  [\setups{text:header:even}]
  []

\startsetups text:header:odd
  \getmarking[chapter][current]
  \quad\vrule\quad
  \pagenumber
\stopsetups

\startsetups text:header:even
  \pagenumber
  \quad\vrule\quad
  \getvariable{l10n-manual}{title}
\stopsetups

%
% TOC
%
\definecombinedlist
  [content]
  [chapter,section]
  [criterium=all,
   level=section]

\setuplist
  [chapter]
  [textstyle=\bia,
   numberstyle=\tfa,
   pagestyle=\tfb]

\setuplist
  [section]
  [numbercommand=\dummyone]

\def\dummyone#1{} % fixme

%
% interaction
%

\startmode[screen]
  \definecolor[niceblue][r=.4, g=.6, b=1]
  \setupinteraction
    [state=start,
     focus=standard,
     color=niceblue,
     style=normal,
     page=no,
     title=\getvariable{l10n-manual}{title},
     subtitle=\getvariable{l10n-manual}{subtitle},
     author={\getvariable{l10n-manual}{author},
             \getvariable{l10n-manual}{translator1},
             \getvariable{l10n-manual}{translator2}},
     keyword=\getvariable{l10n-manual}{keywords}]

  \placebookmarks
    [chapter]
   %[chapter,section,subsection]

  \setupinteractionscreen
    [option=bookmark]

  \setupcombinedlist[content][interaction=pagenumber]
\stopmode

%
% frontmatter
%
\startsectionblockenvironment[frontpart]
   \setupheader[state=stop]
   \setupfooter[state=stop]
\stopsectionblockenvironment

%
% spacing
%
%\setupindenting[yes,medium]
%\setupheads[indentnext=yes] % indent after heads

\setupinterlinespace[1.2em]  % inter-line
\setupwhitespace[medium]     % inter-paragraph
\setuptolerance [verytolerant]

%
% layout
%
\setuppapersize[A5][A5]

\setuplayout
  [grid=no,
%  marking=on,
   location=middle,
   alternative=doublesided,
   cutspace=\backspace,
   backspace=\cutspace]

\setupsectionblock[frontpart][page=no]
\setupsectionblock[bodypart] [page=empty]

%\startmode[screen]
%  \setuppapersize
%    [S6][S6]
%
%  \setuplayout
%    [width=middle,
%     height=middle,
%     topspace=50pt,
%     backspace=50pt]
%
%  \setupinteractionscreen
%    [option=max]
%\stopmode

\setupheads
  [aligntitle=float]

\setupalign
  [line]

%
% tables
%
\setuptables[width=.8\paperwidth]

%
% footnotes
%
\setupfootnotes
  [rule=right,
   way=bypage]

%
% itemisation
%
\setupitemize
  [each]
  [serried,packed,joinedup,nowhite,intro]
  [indentnext=no]

\definesymbol[1][{\tfa •}]

%
% examples
%
\defineframed
  [exampleframed]
  [align={right,l2r},
   width=broad,
   frame=off,
   background=screen]

\defineframed
  [rexampleframed]
  [align={right,r2l},
   width=broad,
   frame=off,
   background=screen]

\def\example#1{\exampleframed{\tt #1}} % fixme
\def\rexample#1{\rexampleframed{\tt #1}} % fixme

%
% urls
%
\doifmodeelse{screen}
  {\def\URL#1{\ltr{\goto{#1}[url(#1)]}}}
  {\def\URL#1{\ltr{#1}}}

\def\CURL#1{\crlf\URL{#1}}

%
% keyboard shortcuts
%
\def\KBD#1{{\tt #1}}

%
% misc.
%
\unexpanded\def\zwj  {\char"200D}
\unexpanded\def\zwnj {\char"200C}
\unexpanded\def\rlm  {\char"200F}
\unexpanded\def\lrm  {\char"200E}

\unexpanded\def\type{\groupedcommand{\setgroupedtype\bidilre}{\bidipop}} % fixme

\unexpanded\def\قسم#1{قسم~\about[ref:#1]}
\unexpanded\def\صفحة#1{صفحة~\at[ref:#1]}

\appendtoks \asciimode \to \everystarttext

\stopenvironment
