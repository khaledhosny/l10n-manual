\startenvironment l10n-ar

%
% variables
%
\setvariables
  [l10n-manual]
  [title=]

%
% directionality
%
\usemodule[bidi] % mine, a bit slower
\ctxlua{bidi.enable()}
%\setupdirections[bidi=global] % official, faster but incomplete
\pardir  TRT
\textdir TRT
\primitive\pagedir TRT
\primitive\bodydir TRT

\def\ltr#1{{\bidilre#1\bidipop}}

%
% language
%
\mainlanguage[arabic]

%
% fonts
%
\setupbodyfont[adobearabic, 12pt]

%
% chapter header
%
\definepagebreak
  [ChapterBreak]
  [yes,header,right]

\setuphead
  [chapter]
  [style=\bfd,
   page=ChapterBreak,
   before={\blank[force,4*line]},
   after={\blank[4*line]},
   alternative=margin,
   number=yes,
   numbercommand=\MyChapterNumber,
   header=empty,
   footer=chapterstart]

\def\MyChapterNumber#1{%
  \inframed
    [frame=off,rightframe=on,
     offset=.5em,
     rulethickness=.1ex,
     align=left]{#1}}

\definetext
  [chapterstart]
  [footer]
  [pagenumber]

%
% heads
%
\setuphead
  [section]
  [style=\bic]

\setuphead
  [subsection]
  [style=\bfb]

\setuphead
  [subsubsection]
  [style=\bfa]

\setuphead
  [section,subsection,subsubsection]
  [command=\dummy]

\def\dummy#1#2{#2} % fixme

%
% page numbering
%
\setuppagenumbering
  [alternative=doublesided,
   location=]

\setupheadertexts
  []
  [\setups{text:header:odd}]
  [\setups{text:header:even}]
  []

\startsetups text:header:odd
  \getmarking[chapter][current]
  \quad\vrule\quad
  \pagenumber
\stopsetups

\startsetups text:header:even
  \pagenumber
  \quad\vrule\quad
  \getvariable{l10n-manual}{title}
\stopsetups

%
% TOC
%
\definecombinedlist
  [content]
  [chapter,section]
  [criterium=all,
   level=section]

\setuplist
  [chapter]
  [textstyle=\bia,
   numberstyle=\tfa,
   pagestyle=\tfb]

\setuplist
  [section]
  [numbercommand=\dummyone]

\def\dummyone#1{} % fixme

%
% frontmatter
%
\startsectionblockenvironment[frontpart]
   \setupheader[state=stop]
   \setupfooter[state=stop]
\stopsectionblockenvironment

%
% spacing
%
%\setupindenting[yes,medium]
%\setupheads[indentnext=yes] % indent after heads

\setupinterlinespace[1.2em]  % inter-line
\setupwhitespace[medium]     % inter-paragraph
\setuptolerance [verytolerant]
\setupalign     [hz,hanging,line]%,nothyphenated]

%
% layout
%
\setuppapersize
  [A5]
  [A5]%[A4]
\setuplayout
  [grid=no,
%  marking=on,
   location=middle]

\setupheads
  [aligntitle=float]

%
% tables
%
\SetTableToWidth{.8\paperwidth} % fixme

%
% footnotes
%
\setupfootnotes
  [rule=right,
   way=bypage]

%
% itemisation
%
\setupitemize
  [each]
  [serried,packed,joinedup,nowhite,intro]
  [indentnext=no]

\definesymbol[1][{\tfa â€¢}]

%
% examples
%
\defineframed
  [exampleframed]
  [align={right,l2r},
   width=broad,
   frame=off,
   background=screen]

\defineframed
  [rexampleframed]
  [align={right,r2l},
   width=broad,
   frame=off,
   background=screen]

\def\example#1{\exampleframed{\tt #1}} % fixme
\def\rexample#1{\rexampleframed{\tt #1}} % fixme

%
% urls
%
\def\URL#1{\ltr{\language[en]\tt\hyphenatedurl{#1}}}
\def\CURL#1{\crlf\URL{#1}}

%
% keyboard shortcuts
%
\def\KBD#1{{\tt #1}}

%
% misc.
%
\unexpanded\def\zwj  {\char"200D}
\unexpanded\def\zwnj {\char"200C}
\unexpanded\def\rlm  {\char"200F}
\unexpanded\def\lrm  {\char"200E}

\unexpanded\def\Type{\groupedcommand{\setgroupedtype\bidilre}{\bidipop}} % fixme

\stopenvironment
