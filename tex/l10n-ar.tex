\startenvironment l10n-ar

%
% variables
%
\setvariables
  [l10n-manual]
  [title=]

%
% directionality
%
\usemodule[directions] % mine, a bit slower
\ctxlua{bidi.enable()}
%\setupdirections[bidi=global] % official, faster but incomplete
\pardir  TRT
\textdir TRT
\primitive\pagedir TRT
\primitive\bodydir TRT

\def\ltr#1{\bidilre#1\bidipop}

%
% language
%
\mainlanguage[arabic]

%
% fonts
%
\definefontfeature
  [arabic]
  [arabic]
  [protrusion=quality,expansion=quality,
   %anum=yes,tlig=yes,
   formatters=strip]
\definefontfeature
  [arabic-mono]
  [arabic]
  [anum=no,tlig=no]
\definefontfeature
  [default]
  [default]
  [protrusion=quality,expansion=quality
  formatters=strip]

\usetypescript[adobearabic]
\setupbodyfont[adobearabic, 16pt]

%
% chapter header
%
\setuphead
  [chapter]
  [page=yes,
   before={\blank[force,4*line]},
   after={\blank[4*line]},
   alternative=margin,
   numbercommand=\MyChapterNumber,
   header=empty,
   footer=chapterstart]

\def\MyChapterNumber#1{%
  \inframed
    [frame=off,rightframe=on,
     offset=.5em,
     rulethickness=.1ex,
     align=left]{#1}}

\definetext
  [chapterstart]
  [footer]
  [pagenumber]

%
% heads
%
\setuphead
  [chapter]
  [style=\bfd]

\setuphead
  [section]
  [style=\bic]

\setuphead
  [subsection]
  [style=\bfb]

\setuphead
  [subsubsection]
  [style=\bfa]

\setuphead
  [section,subsection,subsubsection]
  [number=no]

%
% page numbering
%
\setuppagenumbering
  [alternative=doublesided,
   location=]

\setupheadertexts
  [\setups{text:header:odd}]
  []
  []
  [\setups{text:header:even}]

\startsetups text:header:odd
  \pagenumber
  \quad\vrule\quad
  \hbox{\getmarking[chapter][current]} % XXX: hbox
\stopsetups

\startsetups text:header:even
  \hbox{\getvariable{l10n-manual}{title}} % XXX: hbox
  \quad\vrule\quad
  \pagenumber
\stopsetups

%
% TOC
%
\definecombinedlist
  [content]
  [chapter,section]
  [alternative=a,
   width=.2\textwidth,
   numbercommand=\MyTocNumber,
   criterium=all,
   level=section]

\def\MyTocNumber#1{\hbox to 2em{\hfill #1}}

%
% frontmatter
%
\startsectionblockenvironment[frontpart]
   \setupheader[state=stop]
   \setupfooter[state=stop]
\stopsectionblockenvironment

%
% spacing
%
%\setupindenting[yes,medium]
%\setupheads[indentnext=yes] % indent after heads

\setupinterlinespace[1.2em]  % inter-line
\setupwhitespace[medium]     % inter-paragraph
\setuptolerance [verytolerant]
\setupalign     [hz,hanging]%,nothyphenated]

%
% layout
%
\setuplayout
  [grid=no]%{yes, force}]
%\showgrid

\setupheads
  [aligntitle=float]
%
% footnotes
%
\setupfootnotes
  [rule=right]

%
% itemisation
%
\setupitemize
  [1]
  [serried,packed,joinedup,nowhite,after]
  [indentnext=no]

\definesymbol[1][{\tfa â€¢}]

%
% examples
%
\defineframed
  [exampleframed]
  [align={right,l2r},
   width=broad,
   frame=off,
   background=screen]

\def\example#1{\exampleframed{\tt #1}}

%
% urls
%
\def\URL#1{{\bidilre\language[en]\tt\hyphenatedurl{#1}\bidipop}}
\def\CURL#1{\midaligned{\URL{#1}}}

%
% keyboard shortcuts
%
\def\KBD#1{{\tt #1}}

\stopenvironment
